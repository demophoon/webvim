<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Terminal Test Page</title>

    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

    <style>
        html {
            background: #121212;
            padding: 0px;
            margin: 0px;
            overflow: hidden;
        }

        h1 {
            margin-bottom: 20px;
            font: 20px/1.5 sans-serif;
        }

        .terminal {
            padding: 5px;
            font-family: "Ubuntu Mono", "DejaVu Sans Mono", "Liberation Mono", monospace;
            font-size: 16px;
            color: #f0f0f0;
            background: #121212 !important;
        }

        .terminal-cursor {
            color: #000;
            background: #f0f0f0;
        }
    </style>

    <script type="text/javascript" charset="utf-8" src="/static/js/term.js"></script>
    <script type="text/javascript" src="http://cdn.brittg.com/js/jquery.js"></script>
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>

    </head>
    <body>


        <div id="vim_terminal"></div>

        <script type="text/javascript" charset="utf-8">

            (function() {
                function init() {
                    var term = new Terminal({
                        cols: 120,
                        rows: 40,
                        screenKeys: true,
                    });
                    var sock = new SockJS('/terminal');
                    sock.onopen = function() {
                        term.fixResize();
                        sock.ready = true;
                    };
                    sock.onmessage = function(e) {
                        term.write(e.data);
                    };
                    sock.onclose = function() {
                        sock.ready = false;
                    };
                    term.open(document.getElementById("vim_terminal"));
                    term.on('data', function(data) {
                        sock.send("0" + data);
                    });
                    term._resize = term.resize;
                    term.resize = function(x, y) {
                        term._resize(x, y);
                        sock.send("1" + x + "," + y);
                    }
                    term.fixResize = function() {
                        var cols = Math.floor((window.innerWidth - 24) / 8);
                        var rows = Math.floor((window.innerHeight - 48) / 16);
                        term.resize(cols, rows)
                    }
                    sock.keepAlive = setInterval(function() {
                        if (sock.ready) {
                            sock.send(" ");
                        }
                    }, 500);

                    var rtime = new Date(1, 1, 2000, 12,00,00);
                    var timeout = false;
                    var delta = 200;
                    $(window).resize(function() {
                        rtime = new Date();
                        if (timeout === false) {
                            timeout = true;
                            setTimeout(resizeend, delta);
                        }
                    });
                    function resizeend() {
                        if (new Date() - rtime < delta) {
                            setTimeout(resizeend, delta);
                        } else {
                            timeout = false;
                            term.fixResize();
                        }
                    }

                }

                $(document).ready(init);
            }());

        </script>
    </body>
</html>
